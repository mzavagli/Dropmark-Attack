## RST on close

If a listening socket has sockets in the accept queue, closing the listening
socket will send a RST to each peer.

```bash
sudo tcpdump -i lo -nn 'tcp and port 9000'
```

```python3
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind(('127.0.0.1', 9000))
s.listen()
# after connecting the client
s.close()
```

```python3
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('127.0.0.1', 9000))
```

```text
17:11:01.647874 IP 127.0.0.1.42250 > 127.0.0.1.9000: Flags [S], seq 4149889178, win 65495, options [mss 65495,sackOK,TS val 2635003237 ecr 0,nop,wscale 7], length 0
17:11:01.647911 IP 127.0.0.1.9000 > 127.0.0.1.42250: Flags [S.], seq 3858517852, ack 4149889179, win 65483, options [mss 65495,sackOK,TS val 2635003238 ecr 2635003237,nop,wscale 7], length 0
17:11:01.647942 IP 127.0.0.1.42250 > 127.0.0.1.9000: Flags [.], ack 1, win 512, options [nop,nop,TS val 2635003238 ecr 2635003238], length 0
17:11:19.590701 IP 127.0.0.1.9000 > 127.0.0.1.42250: Flags [R.], seq 1, ack 1, win 512, options [nop,nop,TS val 2635021180 ecr 2635003238], length 0
```

## State change on close

If a listening socket is close()d, it will be closed immediately and not
transition to the time-wait state. All child sockets (sockets for incoming
connections that have not yet been accept()ed) will also be closed immediately
and not transition to the time-wait state.

This seems to conflict with RFC 9293:

> A TCP user or application can issue a reset on a connection at any time,
> though reset events are also generated by the protocol itself when various
> error conditions occur, as described below. The side of a connection issuing
> a reset should enter the TIME-WAIT state, as this generally helps to reduce
> the load on busy servers for reasons described in [...].

> When a connection is closed actively, it MUST linger in the TIME-WAIT state
> for a time 2xMSL (Maximum Segment Lifetime) (MUST-13). However, it MAY accept
> a new SYN from the remote TCP endpoint to reopen the connection directly from
> TIME-WAIT state (MAY-2), if [...]

When a close() is issued on the listening socket, neither the listening socket
nor its children enter the time-wait state.

```python3
import socket
s1 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s1.bind(('127.0.0.10', 10000))
s1.listen()
```

```
$ ss --tcp --all --numeric '( src 127.0.0.10 or dst 127.0.0.10 )'
State    Recv-Q    Send-Q    Local Address:Port    Peer Address:Port
LISTEN   0         128       127.0.0.10:10000      0.0.0.0:*
```

```python3
s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s2.connect(('127.0.0.10', 10000))
```

```
$ ss --tcp --all --numeric '( src 127.0.0.10 or dst 127.0.0.10 )'
State    Recv-Q    Send-Q    Local Address:Port    Peer Address:Port
LISTEN   1         128       127.0.0.10:10000      0.0.0.0:*
ESTAB    0         0         127.0.0.1:35956       127.0.0.10:10000
ESTAB    0         0         127.0.0.10:10000      127.0.0.1:35956
```

```python3
s1.close()
```

```
$ ss --tcp --all --numeric '( src 127.0.0.10 or dst 127.0.0.10 )'
State    Recv-Q    Send-Q    Local Address:Port    Peer Address:Port
```
